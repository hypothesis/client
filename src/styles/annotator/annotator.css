/*
Styles for annotator UI elements. This stylesheet is loaded within shadow roots
to avoid affecting the host page. Styles for elements (eg. highlights) which do
not use shadow roots go in other bundles (eg. highlights.css,
pdfjs-overrides.scss).

# Important note about CSS custom @property declarations

Tailwind generates CSS that relies on custom @property declarations. These
declarations are ignored when loaded in Shadow DOM. To work around that we have
logic in `src/annotator/util/shadow-root.ts` to duplicate the properties in the
host page. See shadow-root.ts for more details.
*/

@import 'tailwindcss' source(none);

@import '@hypothesis/frontend-shared/tailwind-config.css';

@source '../../{annotator, shared}/**/*.{js,ts,tsx}';
@source '../../../node_modules/@hypothesis/frontend-shared/lib/**/*.js';

@theme {
  --animate-adder-pop-down: adder-pop-down 0.08s ease-in forwards;

  @keyframes adder-pop-down {
    0% {
      opacity: 0.05;
      transform: scale(0.8) translateY(10px);
    }
    20% {
      opacity: 0.7;
    }
    100% {
      opacity: 1;
      transform: scale(1) translateY(0px);
    }
  }

  --animate-adder-pop-up: adder-pop-up 0.08s ease-in forwards;

  @keyframes adder-pop-up {
    0% {
      opacity: 0.05;
      transform: scale(0.8) translateY(-10px);
    }
    20% {
      opacity: 0.7;
    }
    100% {
      opacity: 1;
      transform: scale(1) translateY(0px);
    }
  }

  /* A more prominent shadow than the one used by tailwind, intended for
     popovers and menus. */
  --shadow-intense: 0px 2px 10px 0px rgb(0 0 0 / 0.25);

  /* The shadow shown along the edge of the sidebar in the clean theme. */
  --shadow-sidebar: 0px 1px 4px rgb(0, 0, 0, 0.5);

  --font-sans: 'Helvetica Neue', Helvetica, Arial, 'Lucida Grande', sans-serif;

  /* Font sizes for annotator controls that should scale with text in the document. */
  --text-annotator-sm: calc(0.75 * var(--hypothesis-font-size));
  --text-annotator-base: calc(0.875 * var(--hypothesis-font-size));
  --text-annotator-lg: var(--hypothesis-font-size);
  --text-annotator-xl: calc(1.125 * var(--hypothesis-font-size));

  /* These are known cases when we want absolute sizing for fonts so
     that they do not scale, for example annotator components that are
     rendered next to the sidebar (which doesn't scale with host root
     font sizing). */
  --text-px-base: 16px;

  --breakpoint-2xl: 1220px;
  --breakpoint-annotator-sm: 240px;
  --breakpoint-annotator-md: 480px;
  --breakpoint-annotator-lg: 600px;
}

/* Add a custom variant such that the `sidebar-collapsed:` modifier
   is available. The `Sidebar` logic adds the `.sidebar-collapsed`
   class to the sidebar frame when it's collapsed. This modifier allows
   sub-components to select for that state. */
@custom-variant sidebar-collapsed {
  .sidebar-collapsed & {
    @slot;
  }
}

/* Tailwind has a built-in pointer-coarse variant. This alias exists for
   compatibility. */
@custom-variant touch {
  @media (pointer: coarse) {
    @slot;
  }
}

/* Styles for `<hypothesis-*>` elements in the host page.

   `:host` rules have lower precedence than global CSS, unless `!important` is used.
   See https://stackoverflow.com/questions/54821175/. */
:host {
  /* Define the reference font size used by `text-annotator-<size>` utilities.
   
     We try to respect the document's standard font size, but clamp to ensure
     text is always readable. See https://github.com/hypothesis/client/issues/4615. */
  --hypothesis-font-size: 16px; /* Fallback */
  --hypothesis-font-size: clamp(16px, 1rem, 24px);

  /* Our host elements have zero width/height, as they are just containers for
     the shadow roots. Therefore we must override any page styles which would
     cause them to clip their contents. See eg. https://github.com/hypothesis/client/issues/4641. */
  overflow: visible !important;
}

/* Styles for all top-level elements in shadow roots. */
:host > * {
  @apply font-sans;
}

@utility sidebar-transition-margin {
  /* This transition makes the sidebar slide in and off of the screen
     when opening or closing. */
  @apply transition-[margin-left] duration-150 ease-[cubic-bezier(0.55,0,0.2,0.8)];
}

@utility sidebar-transition-visibility {
  /* This transition delays the visibility change to when
     collapsing the sidebar. This serves to delay
     the effect until the sidebar finishes closing. Visibility is
     a boolean value and can not actually animate. */
  @apply invisible transition-[visibility] duration-150;
}

@layer base {
  /* See https://tailwindcss.com/docs/upgrade-guide#default-border-color. */
  * {
    border-color: #dbdbdb;
  }
}

/* See https://tailwindcss.com/docs/upgrade-guide#default-ring-width-and-color. */
@theme {
  --default-ring-width: 2px;
  --default-ring-color: #59a7e8;
}

@layer components {
  .sidebar-container {
    /* Typically applied as an HTML attribute; there is no corresponding
       tailwind utility class */
    direction: ltr;

    /* Full height, fixed position all the way to the right (offscreen) to start */
    @apply fixed top-0 left-full h-full z-max select-none;

    /* Next, set different widths and left-margin positions for different
       breakpoints. */
    @apply annotator-sm:w-[90%] annotator-sm:ml-[-90%];
    @apply annotator-md:w-[70%] annotator-md:ml-[-70%];
    @apply annotator-lg:w-[428px] annotator-lg:ml-[-428px];

    /* Wider screens: apply transition when opening/closing of the sidebar. */
    @apply annotator-lg:sidebar-transition-margin;

    &.is-hidden {
      @apply sidebar-transition-visibility;
    }

    /* We can't use `theme-clean:` or `sidebar-collapsed:` tailwind modifiers
       here because this is the one place in the project where the relevant
       classes are assigned to the same element, not a parent element. */
    &.theme-clean {
      @apply shadow-sidebar;
    }

    &.sidebar-collapsed {
      @apply ml-0;
    }
  }

  /* The sidebar's iframe */
  .sidebar-frame {
    @apply relative border-0 h-full w-full z-3;
    @apply sidebar-collapsed:sidebar-transition-visibility;
  }

  /* This disables the width transition for the sidebar when
     it is manually resized by dragging. */
  .sidebar-no-transition {
    transition: none !important;
  }

  /* Stop inherited values from the parent page from affecting styles in
     Hypothesis UI components.

     Although this is really a utility, it is in the `@components` layer so
     that it can be overridden by utilities applied to the same element.
  */
  .all-initial {
    all: initial;
  }
}
