'use strict';

const retry = require('retry');

/**
 * Retry a Promise-returning operation until it succeeds or
 * fails after a set number of attempts.
 *
 * @param {Function} opFn - The operation to retry
 * @param {Object} options - The options object to pass to retry.operation()
 *
 * @return A promise for the first successful result of the operation, if
 *         it succeeds within the allowed number of attempts.
 */
function retryPromiseOperation(opFn, options) {
  return new Promise(function(resolve, reject) {
    const operation = retry.operation(options);
    operation.attempt(function() {
      opFn()
        .then(function(result) {
          operation.retry();
          resolve(result);
        })
        .catch(function(err) {
          if (!operation.retry(err)) {
            reject(err);
          }
        });
    });
  });
}

module.exports = {
  retryPromiseOperation: retryPromiseOperation,
};
